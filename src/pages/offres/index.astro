---
import Layout from '../../layouts/Layout.astro';
import OffreCard from '../../components/OffreCard.astro';
import { getOffres, filterByPrix } from '../../js/backend.mjs';

let Offres;
let message = '';
if (Astro.request.method === "POST") {
    const data = await Astro.request.formData();
    const minPrix = parseInt(data.get("minPrix") as string);
    const maxPrix = parseInt(data.get("maxPrix") as string);

    // Validations côté serveur renforcées
    if (isNaN(minPrix) || isNaN(maxPrix)) {
        message = "Veuillez entrer des nombres valides.";
        Offres = await getOffres();
    } else if (minPrix < 0 || maxPrix < 0) {
        message = "Les prix ne peuvent pas être négatifs.";
        Offres = await getOffres();
    } else if (minPrix > 100000000 || maxPrix > 100000000) {
        message = "Les prix ne peuvent pas dépasser 100 millions.";
        Offres = await getOffres();
    } else if (maxPrix <= minPrix) {
        message = "Le prix maximum doit être supérieur au prix minimum.";
        Offres = await getOffres();
    } else {
        Offres = await filterByPrix(minPrix, maxPrix);
        if (Offres.length === 0) {
            message = `Pas d'offres entre ${minPrix}€ et ${maxPrix}€`;
        } else {
            message = `Liste des offres entre ${minPrix}€ et ${maxPrix}€`;
        }
    }
} else {
    Offres = await getOffres();
}
---

<Layout titre="Offres">
        <h1 class="text-2xl text-center">Offres</h1>
        <p class="text-center">Découvrez nos offres exceptionnelles !</p>
        <div class="text-center my-4">
            <a href="/offres/add" class="inline-block text-white px-6 py-3 rounded-lg transition-colors duration-200 shadow-md hover:shadow-lg" style="background-color: #334155;">+ Ajouter une nouvelle offre</a>
        </div>
        <form action="/offres" method="POST" class="flex flex-wrap gap-2 justify-center items-center my-4">
            <input 
                type="number" 
                name="minPrix" 
                placeholder="Prix minimum" 
                required
                min="0" 
                max="100000000" 
                step="1"
                class="p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-slate-700" 
            />
            <input 
                type="number" 
                name="maxPrix" 
                placeholder="Prix maximum" 
                required
                min="0" 
                max="100000000" 
                step="1"
                class="p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-slate-700" 
            />
            <input type="submit" value="Filtrer par prix" class="px-6 py-2 text-white rounded-lg transition-colors duration-200 shadow-md hover:shadow-lg cursor-pointer" style="background-color: #334155;" />
        </form>
        {message && <p class="mt-2 p-3 border border-gray-300 rounded-md text-center bg-gray-50">{message}</p>}
        <div class="text-center my-4">
            <a href="/offres/surface/80" class="inline-block text-white px-6 py-3 rounded-lg" style="background-color: #334155; hover:background-color: #1e293b;">Voir les maisons de plus de 80 m²</a>
        </div>
    <button id="favori-button" class="rounded-lg text-white p-2 mb-4 mt-8" style="background-color: #334155; hover:background-color: #1e293b;">Afficher les favoris</button>
    <div id="offres-container">
        {
            Offres.map(offre => (
                <div class="offre" data-favori={offre.favoris.toString()}>
                    <OffreCard {...offre} />
                </div>
            ))
        }
    </div>
    <script>
        const button = document.getElementById('favori-button');
        const offresContainer = document.getElementById('offres-container')!;
        let showingFavoris = false;

        button?.addEventListener('click', () => {
            showingFavoris = !showingFavoris;
            const offres: NodeListOf<HTMLElement> = offresContainer.querySelectorAll('.offre');
            offres.forEach(offre => {
                const isFavori = offre.getAttribute('data-favori') === 'true';
                if (showingFavoris && !isFavori) {
                    offre.style.display = 'none';
                } else {
                    offre.style.display = 'block';
                }
            });
            button.textContent = showingFavoris ? 'Afficher toutes les offres' : 'Afficher les favoris';
        });
    </script>
</Layout>
